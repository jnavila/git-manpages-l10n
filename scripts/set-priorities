#!/usr/bin/python3

import polib
import sys
import re
from os.path import join, dirname
from sources import SECTIONS

INCLUDE_REGEX = re.compile('''include::(.*)\\[\\]\n''')


def process_file(filename, priority, priorities):
    basedirname = dirname(filename)
    try:
        with open(filename, 'r') as f:
            for line in f.readlines():
                match = INCLUDE_REGEX.fullmatch(line)
                if match:
                    filename = join(basedirname, match.group(1))
                    priorities[filename] = max(priority, priorities.get(filename, 100))
                    process_file(filename, priority, priorities)
    except Exception:
        print("could not find " + filename)


def main(f_list):
    priorities = dict((join('en', source), section) for section in SECTIONS for source in SECTIONS[section])
    items = list(priorities.items())
    for source, priority in items:
        process_file(source, priority, priorities)
    for source in f_list:
        po = polib.pofile(source, wrapwidth=0)
        for entry in po:
            if not entry.obsolete:
                flags = [f for f in entry.flags if not (f.startswith("priority") or f.isdigit())]
                p = max(priorities.get(filename, 100) for (filename, _) in entry.occurrences)
                flags.append("priority:{}".format(p))
                entry.flags = flags
        po.save(source)


if __name__ == '__main__':
    if len(sys.argv) > 1:
        main(sys.argv[1:])
